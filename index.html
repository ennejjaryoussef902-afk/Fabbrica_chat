<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabbrica Chat - Real Time Firestore</title>
    <!-- Caricamento di Tailwind CSS per lo stile reattivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Caricamento del font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Sfondo scuro di GitHub */
        }
        /* Stile personalizzato per la scrollbar */
        #messages {
            scrollbar-width: thin;
            scrollbar-color: #3b82f6 #1f2937;
        }
        #messages::-webkit-scrollbar {
            width: 8px;
        }
        #messages::-webkit-scrollbar-track {
            background: #1f2937;
        }
        #messages::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 20px;
            border: 2px solid #1f2937;
        }
        /* Stile per il pulsante LLM in caricamento */
        .loading-button {
            cursor: not-allowed;
            opacity: 0.6;
            position: relative;
            color: transparent !important; /* Nasconde il testo */
        }
        .loading-button::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin: -8px 0 0 -8px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Contenitore Principale Chat -->
    <div class="w-full max-w-lg bg-gray-800 rounded-xl shadow-2xl overflow-hidden flex flex-col h-[90vh]">

        <!-- Header e Configurazione Stanza -->
        <header class="p-4 bg-gray-900 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-blue-400">Fabbrica Chat</h1>
            <div id="status-message" class="text-xs text-green-400 mt-1">Inizializzazione...</div>
            
            <div class="flex items-center space-x-2 mt-3">
                <input type="text" id="username" placeholder="Nome Utente (es. Youssef)"
                       class="flex-grow p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-blue-500 focus:border-blue-500"
                       maxlength="20">
                <input type="text" id="room-id" placeholder="Nome Stanza (es. Progetto-1)"
                       class="flex-grow p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-blue-500 focus:border-blue-500"
                       value="Generale">
                <button onclick="changeRoom()"
                        class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                    Entra
                </button>
            </div>
            <div id="current-room-display" class="mt-2 text-sm text-gray-400">
                Stanza Attuale: **Generale**
            </div>
        </header>

        <!-- Area Messaggi -->
        <div id="messages" class="flex-grow p-4 space-y-3 overflow-y-auto bg-gray-800">
            <!-- I messaggi saranno iniettati qui da JavaScript -->
            <p class="text-center text-gray-500 mt-4">Caricamento...</p>
        </div>

        <!-- Funzionalità Gemini -->
        <div class="p-4 pt-0 bg-gray-800 space-y-3">
            <!-- Row 1: Context/Suggestion -->
            <div class="flex justify-between space-x-3">
                <button id="summarize-btn" onclick="summarizeChat()"
                        class="flex-1 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <span class="mr-1">✨</span> Riassumi Stanza
                </button>
                <button id="suggest-btn" onclick="suggestReply()"
                        class="flex-1 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <span class="mr-1">✨</span> Suggerisci Risposta
                </button>
            </div>
            
            <!-- Row 2: Text Refinement -->
            <div class="flex justify-between space-x-3">
                <button id="rewrite-pro-btn" onclick="rewriteText('professional')"
                        class="flex-1 px-4 py-2 bg-teal-500 text-white font-semibold rounded-lg hover:bg-teal-600 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <span class="mr-1">✨</span> Riscrivi Pro
                </button>
                <button id="rewrite-friendly-btn" onclick="rewriteText('friendly')"
                        class="flex-1 px-4 py-2 bg-rose-500 text-white font-semibold rounded-lg hover:bg-rose-600 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    <span class="mr-1">✨</span> Riscrivi Amichevole
                </button>
            </div>
        </div>

        <!-- Form Invio Messaggio -->
        <div class="p-4 bg-gray-900 border-t border-gray-700">
            <div class="flex space-x-3">
                <input type="text" id="message-input" placeholder="Scrivi il tuo messaggio..."
                       class="flex-grow p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-blue-500 focus:border-blue-500"
                       onkeydown="if (event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()"
                        class="px-5 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 shadow-lg active:scale-95 transform">
                    Invia
                </button>
            </div>
        </div>

    </div>

    <!-- Script di Firebase e Gemini SDK -->
    <script type="module">
        // Importa le funzioni essenziali di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        //                 CONFIGURAZIONE FIREBASE & GEMINI
        // =================================================================

        // VARIABILI GLOBALI CON LE TUE CHIAVI REALI DI FIREBASE
        const appId = 'fabbrica-chat'; // ID Progetto usato nel percorso di Firestore
        const firebaseConfig = {
          apiKey: "AIzaSyCKWINmcJd0X4yK4kop-VykEEYUYvuVpWY",
          authDomain: "fabbrica-chat.firebaseapp.com",
          projectId: "fabbrica-chat",
          storageBucket: "fabbrica-chat.firebasestorage.app",
          messagingSenderId: "480315431083",
          appId: "1:480315431083:web:a712a56d83cc379542bfee"
        };
        const initialAuthToken = null; 
        
        // Costanti Gemini
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const GEMINI_API_KEY = ""; // L'API Key sarà fornita dall'ambiente di Canvas
        
        // =================================================================
        //                 INIZIALIZZAZIONE E STATO GLOBALE
        // =================================================================

        let app, db, auth, userId = 'anonimo';
        let currentRoomId = 'Generale';
        let unsubscribe = null; 
        let currentMessages = []; // Memorizza i messaggi attuali per l'LLM

        // Punti di attacco DOM
        const messagesElement = document.getElementById('messages');
        const statusElement = document.getElementById('status-message');
        const roomDisplay = document.getElementById('current-room-display');
        const summarizeBtn = document.getElementById('summarize-btn');
        const suggestBtn = document.getElementById('suggest-btn');
        const rewriteProBtn = document.getElementById('rewrite-pro-btn'); // NUOVO
        const rewriteFriendlyBtn = document.getElementById('rewrite-friendly-btn'); // NUOVO
        const messageInput = document.getElementById('message-input');


        // Funzione per inizializzare l'applicazione
        async function initApp() {
            try {
                // 1. Inizializzazione Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase App e Firestore inizializzati.");
                statusElement.textContent = "Connesso a Firebase. Autenticazione in corso...";

                // 2. Autenticazione Anonima
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Autenticato con UID:", userId);
                        statusElement.textContent = `Connesso alla Stanza "${currentRoomId}" come: Utente (${user.uid.substring(0, 8)}...)`;
                        listenForMessages(); 
                    } else {
                        // Tenta l'accesso anonimo (richiede l'attivazione in Firebase Console)
                        signInAnonymously(auth).catch(error => {
                            if (error.code === 'auth/configuration-not-found') {
                                // ***************************************************************
                                // *** MESSAGGIO CRITICO: QUI È DOVE VIENE CATTURATO L'ERRORE ***
                                // ***************************************************************
                                statusElement.className = "text-xs text-red-500 mt-1";
                                statusElement.textContent = `ERRORE FATALE: Attiva 'Anonymous' in Firebase Auth. Il codice non può risolvere questo.`;
                                console.error("ERRORE: Authentication non configurata. Vai su Firebase > Build > Authentication e attiva l'accesso Anonimo.", error);
                            } else {
                                statusElement.className = "text-xs text-red-500 mt-1";
                                statusElement.textContent = `Errore di Autenticazione: ${error.code}`;
                                console.error("Errore nell'autenticazione anonima:", error);
                            }
                        });
                    }
                });

                // Imposta il nome utente predefinito
                const storedUsername = localStorage.getItem('chatUsername');
                if (storedUsername) {
                    document.getElementById('username').value = storedUsername;
                } else {
                    document.getElementById('username').value = `User-${Math.floor(Math.random() * 900) + 100}`;
                }

            } catch (error) {
                console.error("Errore fatale nell'inizializzazione:", error);
                statusElement.textContent = `Errore di Configurazione: Controlla le chiavi Firebase.`;
            }
        }

        // =================================================================
        //                 GESTIONE MESSAGGI (FIREBASE)
        // =================================================================

        window.sendMessage = async function() {
            const username = document.getElementById('username').value.trim() || 'Anonimo';
            const text = messageInput.value.trim();

            if (text === '' || !db || !auth.currentUser) return;
            
            localStorage.setItem('chatUsername', username);

            try {
                const messagesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'messages');
                
                await addDoc(messagesColRef, {
                    username: username,
                    text: text,
                    timestamp: serverTimestamp(),
                    userId: auth.currentUser.uid
                });

                messageInput.value = ''; 
                statusElement.className = "text-xs text-green-400 mt-1";
                statusElement.textContent = `Messaggio inviato alla Stanza "${currentRoomId}"!`;
                
            } catch (error) {
                console.error("Errore nell'invio del messaggio:", error);
                statusElement.className = "text-xs text-red-500 mt-1";
                statusElement.textContent = `Invio Fallito: Controlla le regole Firestore.`;
            }
        }

        function renderMessages(messages) {
            messagesElement.innerHTML = ''; 

            if (messages.length === 0) {
                messagesElement.innerHTML = '<p class="text-center text-gray-500 mt-4">Nessun messaggio. Invia il primo!</p>';
                if (auth.currentUser) {
                    statusElement.className = "text-xs text-green-400 mt-1";
                    statusElement.textContent = `Connesso alla Stanza "${currentRoomId}" - Invia il primo messaggio!`;
                }
                return;
            }

            messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            messages.forEach(msg => {
                const isMine = msg.userId === userId;
                const timeStr = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : 'inviato ora';

                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isMine ? 'justify-end' : 'justify-start'}`;

                messageDiv.innerHTML = `
                    <div class="max-w-xs md:max-w-md p-3 rounded-xl shadow-lg ${isMine ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-tl-none'}">
                        <span class="block text-xs font-semibold ${isMine ? 'text-blue-200' : 'text-blue-400'}">${msg.username}</span>
                        <p class="mt-1 text-sm">${msg.text}</p>
                        <span class="block mt-1 text-right text-xs ${isMine ? 'text-blue-300' : 'text-gray-400'}">${timeStr}</span>
                    </div>
                `;
                messagesElement.appendChild(messageDiv);
            });

            messagesElement.scrollTop = messagesElement.scrollHeight;
        }

        function listenForMessages() {
            if (unsubscribe) {
                unsubscribe();
            }

            const messagesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'messages');
            
            // Limitiamo a 50 per mantenere la chat leggera
            const q = query(messagesColRef, orderBy('timestamp', 'desc'), limit(50));

            unsubscribe = onSnapshot(q, (snapshot) => {
                const newMessages = [];
                snapshot.forEach(doc => {
                    newMessages.push(doc.data());
                });
                
                // Aggiorna lo stato globale dei messaggi per l'uso di Gemini
                currentMessages = newMessages.reverse();

                renderMessages(currentMessages); 
            }, (error) => {
                console.error("Errore nell'ascolto dei messaggi:", error);
                statusElement.className = "text-xs text-red-500 mt-1";
                statusElement.textContent = `ERRORE DATI: Controlla le regole di Firestore.`;
            });
        }

        window.changeRoom = function() {
            const newRoomId = document.getElementById('room-id').value.trim() || 'Generale';
            if (newRoomId !== currentRoomId) {
                currentRoomId = newRoomId;
                roomDisplay.innerHTML = `Stanza Attuale: **${currentRoomId}**`;
                messagesElement.innerHTML = '<p class="text-center text-gray-500 mt-4">Caricamento messaggi...</p>';
                if (auth.currentUser && db) { 
                    listenForMessages(); 
                } else {
                    statusElement.className = "text-xs text-yellow-400 mt-1";
                    statusElement.textContent = `Cambiato in "${currentRoomId}". In attesa di autenticazione...`;
                }
            }
        }
        
        // =================================================================
        //                 FUNZIONALITÀ GEMINI
        // =================================================================
        
        // Helper per la chiamata API
        async function fetchGeminiContent(userQuery, systemPrompt) {
            const apiUrl = `${GEMINI_API_URL}${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // Implementazione backoff esponenziale
            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < 2) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    return text || "Generazione fallita: La risposta dell'LLM era vuota.";

                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    return `Errore durante la connessione all'API Gemini: ${error.message}`;
                }
            }
            return "Errore: Tentativi di connessione esauriti.";
        }

        function setButtonState(button, isLoading) {
            button.disabled = isLoading;
            if (isLoading) {
                // Nasconde il testo del pulsante e mostra l'animazione di caricamento CSS
                button.textContent = 'Caricamento...'; 
                button.classList.add('loading-button');
            } else {
                button.classList.remove('loading-button');
                // Reimposta il contenuto del pulsante con l'emoji e il testo
                if (button.id === 'summarize-btn') {
                    button.innerHTML = '<span class="mr-1">✨</span> Riassumi Stanza';
                } else if (button.id === 'suggest-btn') {
                    button.innerHTML = '<span class="mr-1">✨</span> Suggerisci Risposta';
                } else if (button.id === 'rewrite-pro-btn') {
                    button.innerHTML = '<span class="mr-1">✨</span> Riscrivi Pro';
                } else if (button.id === 'rewrite-friendly-btn') {
                    button.innerHTML = '<span class="mr-1">✨</span> Riscrivi Amichevole';
                }
            }
        }

        // 7. Riassumi Stanza (Gemini Feature 1)
        window.summarizeChat = async function() {
            setButtonState(summarizeBtn, true);
            
            if (currentMessages.length === 0) {
                // Invia messaggio di sistema per informare l'utente
                sendMessageAsSystem("Non ci sono messaggi nella stanza da riassumere.");
                setButtonState(summarizeBtn, false);
                return;
            }

            // Prepara il contesto di chat
            const chatContext = currentMessages
                .slice(-25) // Usa solo gli ultimi 25 messaggi
                .map(m => `${m.username}: ${m.text}`)
                .join('\n');

            const systemPrompt = "Sei un assistente di chat. Il tuo compito è riassumere una discussione fornita in un singolo, conciso paragrafo. Mantieni un tono neutrale e professionale.";
            const userQuery = `Riassumi i seguenti messaggi della chat per la stanza "${currentRoomId}":\n\n${chatContext}`;

            const summary = await fetchGeminiContent(userQuery, systemPrompt);

            // Invia il risultato come un messaggio di sistema
            sendMessageAsSystem(`**Riassunto della Stanza "${currentRoomId}" (Gemini AI):**\n${summary}`);

            setButtonState(summarizeBtn, false);
        }

        // 8. Suggerisci Risposta (Gemini Feature 2)
        window.suggestReply = async function() {
            setButtonState(suggestBtn, true);
            
            if (currentMessages.length < 1) {
                sendMessageAsSystem("Non c'è abbastanza contesto per suggerire una risposta. Invia alcuni messaggi prima.");
                setButtonState(suggestBtn, false);
                return;
            }

            // Prepara il contesto di chat (gli ultimi 5 messaggi)
            const chatContext = currentMessages
                .slice(-5) // Usa solo gli ultimi 5 messaggi
                .map(m => `${m.username}: ${m.text}`)
                .join('\n');

            const systemPrompt = "Sei un assistente AI di chat. Il tuo compito è generare una risposta concisa (massimo 1-2 frasi) all'ultimo messaggio della discussione, basandoti sul contesto fornito. Non includere il tuo nome utente.";
            const userQuery = `Basandoti sulla seguente discussione, genera una risposta appropriata da parte dell'utente. Restituisci SOLO il testo della risposta.\n\nContesto:\n${chatContext}`;

            const replyText = await fetchGeminiContent(userQuery, systemPrompt);
            
            if (replyText && !replyText.startsWith("Errore")) {
                // Popola l'input con la risposta suggerita
                messageInput.value = replyText.trim().replace(/^['"]|['"]$/g, ''); // Rimuove eventuali virgolette
                messageInput.focus();
            } else {
                 sendMessageAsSystem(`Impossibile generare un suggerimento. ${replyText}`);
            }

            setButtonState(suggestBtn, false);
        }

        // 9. Riscrivi Testo (Gemini Feature 3 & 4)
        window.rewriteText = async function(tone) {
            const isProfessional = tone === 'professional';
            const button = isProfessional ? rewriteProBtn : rewriteFriendlyBtn;
            setButtonState(button, true);
            
            const originalText = messageInput.value.trim();

            if (originalText.length < 5) {
                sendMessageAsSystem(`Testo troppo corto per la riscrittura. Scrivi almeno 5 caratteri nel campo di testo.`);
                setButtonState(button, false);
                return;
            }

            const targetTone = isProfessional ? 'professionale, formale e conciso' : 'amichevole, informale e caloroso';
            const systemPrompt = `Sei un assistente per la riscrittura del testo. Il tuo compito è riscrivere il testo fornito dall'utente in un tono ${targetTone}. Restituisci SOLO il testo riscritto, senza frasi introduttive o conclusioni. Rispondi solo in italiano.`;
            const userQuery = `Riscrivi il seguente testo nel tono ${targetTone}: "${originalText}"`;

            const rewrittenText = await fetchGeminiContent(userQuery, systemPrompt);
            
            if (rewrittenText && !rewrittenText.startsWith("Errore")) {
                // Popola l'input con il testo riscritto
                messageInput.value = rewrittenText.trim().replace(/^['"]|['"]$/g, '');
                messageInput.focus();
            } else {
                 sendMessageAsSystem(`Impossibile riscrivere il testo. ${rewrittenText}`);
            }

            setButtonState(button, false);
        }
        
        // 10. Helper per inviare messaggi di sistema
        function sendMessageAsSystem(text) {
             const messageDiv = document.createElement('div');
                messageDiv.className = `flex justify-center`;
                messageDiv.innerHTML = `
                    <div class="max-w-md p-3 rounded-xl shadow-lg bg-yellow-900 text-yellow-100 rounded-lg text-sm italic">
                        <p>${text}</p>
                    </div>
                `;
                messagesElement.appendChild(messageDiv);
                messagesElement.scrollTop = messagesElement.scrollHeight;
        }

        // Avvia l'app all'inizio
        initApp();
    </script>
</body>
</html>
